import React from 'react';
import {
  Modal,
  View,
  Text,
  TouchableOpacity,
  TextInput,
  ScrollView,
  Image,
  KeyboardAvoidingView,
  Platform,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';

export default function UploadModalHome({
  modalVisible,
  setModalVisible,
  postText,
  setPostText,
  pickedImages,
  setPickedImages,
  existingImages,
  setExistingImages,
  imagesToRemove,
  setImagesToRemove,
  editingPostId,
  setEditingPostId,
  loading,
  image,
  uploadPost,
  pickImage,
  removeImage,
  styles,
}) {
  return (
    <Modal
      visible={modalVisible}
      transparent
      animationType="slide"
      onRequestClose={() => {
        setModalVisible(false);
        setEditingPostId(null);
        setPostText('');
        setPickedImages([]);
        setExistingImages([]);
        setImagesToRemove([]);
      }}
    >
      <KeyboardAvoidingView
        behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
        style={{ flex: 1 }}
      >
        <View style={styles.uploadModalOverlay}>
          <View style={styles.uploadModalContent}>
            <View style={styles.uploadModalHeader}>
              <Text style={styles.uploadModalTitle}>{editingPostId ? 'Edit Post' : 'Create Post'}</Text>
              <TouchableOpacity
                onPress={() => {
                  setModalVisible(false);
                  setEditingPostId(null);
                  setPostText('');
                  setPickedImages([]);
                  setExistingImages([]);
                  setImagesToRemove([]);
                }}
              >
                <Ionicons name="close" size={24} color="#333" />
              </TouchableOpacity>
            </View>

            <ScrollView
              style={styles.uploadModalBody}
              showsVerticalScrollIndicator={false}
              keyboardShouldPersistTaps="handled"
            >
              <View style={styles.postInputContainer}>
                {image ? (
                  <Image source={image} style={styles.postAvatar} />
                ) : (
                  <View style={[styles.postAvatar, styles.placeholderCircle]}>
                    <Ionicons name="person" size={24} color="#999" />
                  </View>
                )}
                <TextInput
                  style={styles.postTextInput}
                  placeholder="What's on your mind?"
                  placeholderTextColor="#999"
                  value={postText}
                  onChangeText={setPostText}
                  multiline
                  numberOfLines={4}
                />
              </View>

              <Text style={styles.uploadInputLabel}>Photos (Optional)</Text>
              <ScrollView
                horizontal
                showsHorizontalScrollIndicator={false}
                style={{ marginBottom: 16 }}
              >
                {existingImages.map((imageUrl, index) => (
                  <View key={`existing-${index}`} style={styles.postImageContainer}>
                    <Image source={{ uri: imageUrl }} style={styles.postPreviewImage} />
                    <TouchableOpacity
                      onPress={() => {
                        setExistingImages((prev) => prev.filter((_, i) => i !== index));
                        setImagesToRemove((prev) => [...prev, imageUrl]);
                      }}
                      style={styles.postRemoveBtn}
                    >
                      <Ionicons name="close-circle" size={26} color="#fff" />
                    </TouchableOpacity>
                  </View>
                ))}

                {pickedImages.map((item, index) => (
                  <View key={`new-${index}`} style={styles.postImageContainer}>
                    <Image
                      source={{ uri: Array.isArray(item) ? item[0] : item }}
                      style={styles.postPreviewImage}
                    />
                    <TouchableOpacity onPress={() => removeImage(index)} style={styles.postRemoveBtn}>
                      <Ionicons name="close-circle" size={26} color="#fff" />
                    </TouchableOpacity>
                  </View>
                ))}

                <View style={styles.postImageContainer}>
                  <TouchableOpacity onPress={pickImage} style={styles.postAddPhotoBtn}>
                    <Ionicons name="image-outline" size={32} color="#A68C7B" />
                    <Text style={styles.postAddPhotoText}>Add Photo</Text>
                  </TouchableOpacity>
                </View>
              </ScrollView>

              <TouchableOpacity style={styles.uploadButton} onPress={uploadPost} disabled={loading}>
                <Text style={styles.uploadButtonText}>{editingPostId ? 'Update' : 'Post'}</Text>
              </TouchableOpacity>
            </ScrollView>
          </View>
        </View>
      </KeyboardAvoidingView>
    </Modal>
  );
}
