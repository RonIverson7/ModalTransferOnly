import React from 'react';
import { 
  Modal, 
  View, 
  Text, 
  TouchableOpacity, 
  TextInput, 
  ScrollView, 
  Image, 
  FlatList, 
  KeyboardAvoidingView, 
  Platform, 
  TouchableWithoutFeedback,
  Dimensions,
  ActivityIndicator,
  Keyboard
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import DateTimePicker from '@react-native-community/datetimepicker';

const { width: SCREEN_WIDTH } = Dimensions.get('window');

const HomeModal = ({ 
  // Image fullscreen modal props
  selectedImage,
  selectedImages,
  currentImageIndex,
  setSelectedImage,
  setSelectedImages,
  setCurrentImageIndex,
  
  // Create Post modal props
  modalVisible,
  setModalVisible,
  postText,
  setPostText,
  pickedImages,
  setPickedImages,
  existingImages,
  setExistingImages,
  imagesToRemove,
  setImagesToRemove,
  editingPostId,
  setEditingPostId,
  loading,
  image,
  uploadPost,
  pickImage,
  removeImage,
  
  // Comments modal props
  commentModalVisible,
  setCommentModalVisible,
  currentPostComments,
  newCommentText,
  setNewCommentText,
  postComment,
  renderComment,
  commentListRef,
  commentPage,
  hasMoreComments,
  loadingMoreComments,
  loadMoreComments,
  showLessComments,
  
  // Profile modal props
  profileModalVisible,
  setProfileModalVisible,
  firstName,
  setFirstName,
  middleName,
  setMiddleName,
  lastName,
  setLastName,
  userNameField,
  setUserNameField,
  sex,
  setSex,
  birthday,
  setBirthday,
  showDatePicker,
  setShowDatePicker,
  showSexDropdown,
  setShowSexDropdown,
  address,
  setAddress,
  bio,
  setBio,
  about,
  setAbout,
  tempImage,
  tempBackgroundImage,
  formattedDate,
  onChangeDate,
  pickProfileImage,
  pickBackgroundImage,
  handleProfileSave,
  
  // Art Interests modal props
  interestsModalVisible,
  setInterestsModalVisible,
  selectedInterests,
  setSelectedInterests,
  accessToken,
  refreshToken,
  setHasArtPreferences,
  API_BASE,
  
  // Styles
  styles
}) => {
  return (
    <>
      {/* Image fullscreen modal with carousel */}
      <Modal
        visible={selectedImage !== null && selectedImages.length > 0}
        transparent
        animationType="fade"
        onRequestClose={() => {
          setSelectedImage(null);
          setSelectedImages([]);
          setCurrentImageIndex(0);
        }}
      >
        <View style={styles.fullScreenContainer}>
          {/* Close button */}
          <TouchableOpacity 
            style={{
              position: 'absolute',
              top: 40,
              right: 20,
              zIndex: 10,
              backgroundColor: 'rgba(0,0,0,0.5)',
              borderRadius: 20,
              width: 40,
              height: 40,
              justifyContent: 'center',
              alignItems: 'center',
            }}
            onPress={() => {
              setSelectedImage(null);
              setSelectedImages([]);
              setCurrentImageIndex(0);
            }}
          >
            <Ionicons name="close" size={24} color="white" />
          </TouchableOpacity>

          {/* Image counter */}
          {selectedImages.length > 1 && (
            <View style={{
              position: 'absolute',
              top: 40,
              left: 20,
              zIndex: 10,
              backgroundColor: 'rgba(0,0,0,0.7)',
              paddingHorizontal: 12,
              paddingVertical: 6,
              borderRadius: 16,
            }}>
              <Text style={{ color: 'white', fontSize: 14, fontWeight: 'bold' }}>
                {currentImageIndex + 1}/{selectedImages.length}
              </Text>
            </View>
          )}

          {/* Swipeable image carousel */}
          <FlatList
            data={selectedImages}
            horizontal
            pagingEnabled
            showsHorizontalScrollIndicator={false}
            keyExtractor={(item, index) => index.toString()}
            onMomentumScrollEnd={(event) => {
              const index = Math.round(event.nativeEvent.contentOffset.x / event.nativeEvent.layoutMeasurement.width);
              setCurrentImageIndex(index);
            }}
            renderItem={({ item }) => (
              <View style={{ width: SCREEN_WIDTH, justifyContent: 'center', alignItems: 'center' }}>
                <Image source={item} style={styles.fullScreenImage} resizeMode="contain" />
              </View>
            )}
          />
        </View>
      </Modal>

      {/* Create Post modal */}
      <Modal visible={modalVisible} transparent animationType="slide" onRequestClose={() => {
        setModalVisible(false);
        setEditingPostId(null);
        setPostText('');
        setPickedImages([]);
        setExistingImages([]);
        setImagesToRemove([]);
      }}>
        <KeyboardAvoidingView 
          behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
          style={{ flex: 1 }}
        >
          <View style={styles.uploadModalOverlay}>
            <View style={styles.uploadModalContent}>
              <View style={styles.uploadModalHeader}>
                <Text style={styles.uploadModalTitle}>{editingPostId ? 'Edit Post' : 'Create Post'}</Text>
                <TouchableOpacity onPress={() => {
                  setModalVisible(false);
                  setEditingPostId(null);
                  setPostText('');
                  setPickedImages([]);
                  setExistingImages([]);
                  setImagesToRemove([]);
                }}>
                  <Ionicons name="close" size={24} color="#333" />
                </TouchableOpacity>
              </View>

              <ScrollView style={styles.uploadModalBody} showsVerticalScrollIndicator={false} keyboardShouldPersistTaps="handled">
                {/* User Avatar and Text Input */}
                <View style={styles.postInputContainer}>
                  {image ? (
                    <Image source={image} style={styles.postAvatar} />
                  ) : (
                    <View style={[styles.postAvatar, styles.placeholderCircle]}>
                      <Ionicons name="person" size={24} color="#999" />
                    </View>
                  )}
                  <TextInput
                    style={styles.postTextInput}
                    placeholder="What's on your mind?"
                    placeholderTextColor="#999"
                    value={postText}
                    onChangeText={setPostText}
                    multiline
                    numberOfLines={4}
                  />
                </View>

                {/* Image Picker Section */}
                <Text style={styles.uploadInputLabel}>Photos (Optional)</Text>
                <ScrollView 
                  horizontal 
                  showsHorizontalScrollIndicator={false}
                  style={{ marginBottom: 16 }}
                >
                  {/* Show existing images when editing */}
                  {existingImages.map((imageUrl, index) => (
                    <View key={`existing-${index}`} style={styles.postImageContainer}>
                      <Image
                        source={{ uri: imageUrl }}
                        style={styles.postPreviewImage}
                      />
                      <TouchableOpacity 
                        onPress={() => {
                          setExistingImages(prev => prev.filter((_, i) => i !== index));
                          setImagesToRemove(prev => [...prev, imageUrl]);
                        }} 
                        style={styles.postRemoveBtn}
                      >
                        <Ionicons name="close-circle" size={26} color="#fff" />
                      </TouchableOpacity>
                    </View>
                  ))}
                  
                  {/* Show new images */}
                  {pickedImages.map((item, index) => (
                    <View key={`new-${index}`} style={styles.postImageContainer}>
                      <Image
                        source={{ uri: Array.isArray(item) ? item[0] : item }}
                        style={styles.postPreviewImage}
                      />
                      <TouchableOpacity onPress={() => removeImage(index)} style={styles.postRemoveBtn}>
                        <Ionicons name="close-circle" size={26} color="#fff" />
                      </TouchableOpacity>
                    </View>
                  ))}
                  
                  <View style={styles.postImageContainer}>
                    <TouchableOpacity onPress={pickImage} style={styles.postAddPhotoBtn}>
                      <Ionicons name="image-outline" size={32} color="#A68C7B" />
                      <Text style={styles.postAddPhotoText}>Add Photo</Text>
                    </TouchableOpacity>
                  </View>
                </ScrollView>

                {/* Post Button */}
                <TouchableOpacity style={styles.uploadButton} onPress={uploadPost} disabled={loading}>
                  <Text style={styles.uploadButtonText}>{editingPostId ? 'Update' : 'Post'}</Text>
                </TouchableOpacity>
              </ScrollView>
            </View>
          </View>
        </KeyboardAvoidingView>
      </Modal>

      {/* Comments Modal */}
      <Modal
        visible={commentModalVisible}
        animationType="slide"
        onRequestClose={() => setCommentModalVisible(false)}
      >
        <View style={{ flex: 1, backgroundColor: '#f5f5f5', paddingTop: Platform.OS === 'android' ? 8 : 0 }}>
          {/* Header - Fixed at top */}
          <View style={{ 
            flexDirection: 'row', 
            alignItems: 'center', 
            paddingHorizontal: 10, 
            paddingTop: 2,
            paddingBottom: 6,
            backgroundColor: '#f5f5f5', 
            borderBottomWidth: 1, 
            borderBottomColor: '#e0e0e0' 
          }}>
            <TouchableOpacity onPress={() => {
              Keyboard.dismiss();
              setCommentModalVisible(false);
            }}>
              <Ionicons name="arrow-back" size={24} color="#000" />
            </TouchableOpacity>
            <Text style={{ fontSize: 18, fontWeight: 'bold', marginLeft: 10 }}>Comments</Text>
          </View>
          
          {/* Comments List - Static, never moves with keyboard */}
          <View style={{ flex: 1, marginBottom: 60 }}>
            <FlatList
              ref={commentListRef}
              data={currentPostComments}
              keyExtractor={(item) => item.id.toString()}
              renderItem={renderComment}
              keyboardShouldPersistTaps="handled"
              ListEmptyComponent={
                <View style={styles.emptyCommentsContainer}>
                  <Ionicons name="chatbubbles-outline" size={64} color="#A68C7B" style={{ marginBottom: 12 }} />
                  <Text style={styles.emptyCommentsText}>No comments yet</Text>
                  <Text style={styles.emptyCommentsSubtext}>Be the first to comment!</Text>
                </View>
              }
              ListFooterComponent={
                currentPostComments.length > 0 ? (
                  <View>
                    {commentPage > 1 && (
                      <TouchableOpacity 
                        style={[styles.loadMoreCommentsButton, { backgroundColor: '#fff' }]} 
                        onPress={showLessComments}
                      >
                        <View style={{ flexDirection: 'row', alignItems: 'center' }}>
                          <Text style={styles.loadMoreCommentsText}>Show Less</Text>
                          <Ionicons name="chevron-up" size={16} color="#A68C7B" style={{ marginLeft: 4 }} />
                        </View>
                      </TouchableOpacity>
                    )}
                    {hasMoreComments && (
                      <TouchableOpacity 
                        style={styles.loadMoreCommentsButton} 
                        onPress={loadMoreComments}
                        disabled={loadingMoreComments}
                      >
                        {loadingMoreComments ? (
                          <ActivityIndicator size="small" color="#A68C7B" />
                        ) : (
                          <View style={{ flexDirection: 'row', alignItems: 'center' }}>
                            <Text style={styles.loadMoreCommentsText}>Load More Comments</Text>
                            <Ionicons name="chevron-down" size={16} color="#A68C7B" style={{ marginLeft: 4 }} />
                          </View>
                        )}
                      </TouchableOpacity>
                    )}
                  </View>
                ) : null
              }
              contentContainerStyle={
                currentPostComments.length === 0 ? { flex: 1 } : { paddingVertical: 16 }
              }
            />
          </View>
          
          {/* Input Container - Absolutely positioned, only this moves with keyboard */}
          <KeyboardAvoidingView
            behavior="padding"
            keyboardVerticalOffset={0}
            style={{ position: 'absolute', bottom: 0, left: 0, right: 0 }}
          >
            <View style={styles.commentInputContainer}>
              <TextInput
                style={styles.commentInput}
                placeholder="Add a comment..."
                placeholderTextColor="#999"
                value={newCommentText}
                onChangeText={setNewCommentText}
              />
              <TouchableOpacity onPress={postComment} style={styles.sendButton}>
                <Ionicons name="send" size={20} color="white" />
              </TouchableOpacity>
            </View>
          </KeyboardAvoidingView>
        </View>
      </Modal>

      {/* Complete Your Profile Modal */}
      <Modal visible={profileModalVisible} animationType="slide" transparent onRequestClose={() => setProfileModalVisible(false)}>
        <KeyboardAvoidingView 
          behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
          style={{ flex: 1 }}
        >
          <View style={styles.uploadModalOverlay}>
            <View style={styles.uploadModalContent}>
              <View style={styles.uploadModalHeader}>
                <Text style={styles.uploadModalTitle}>Complete Your Profile</Text>
                <TouchableOpacity onPress={() => setProfileModalVisible(false)}>
                  <Ionicons name="close" size={24} color="#333" />
                </TouchableOpacity>
              </View>

              <ScrollView style={styles.uploadModalBody} showsVerticalScrollIndicator={false} keyboardShouldPersistTaps="handled">
                <Text style={styles.uploadInputLabel}>Profile Photo</Text>
                <TouchableOpacity onPress={pickProfileImage} style={styles.uploadImagePicker}>
                  {tempImage ? (
                    <Image source={tempImage} style={styles.uploadPickedImage} />
                  ) : (
                    <View style={styles.uploadImagePlaceholder}>
                      <Ionicons name="person-circle-outline" size={48} color="#A68C7B" />
                      <Text style={styles.uploadImageText}>Tap to add profile photo</Text>
                    </View>
                  )}
                </TouchableOpacity>

                <Text style={styles.uploadInputLabel}>Cover Photo</Text>
                <TouchableOpacity onPress={pickBackgroundImage} style={styles.uploadImagePicker}>
                  {tempBackgroundImage ? (
                    <Image source={{ uri: tempBackgroundImage.uri }} style={styles.uploadPickedImage} />
                  ) : (
                    <View style={styles.uploadImagePlaceholder}>
                      <Ionicons name="image-outline" size={48} color="#A68C7B" />
                      <Text style={styles.uploadImageText}>Tap to add cover photo</Text>
                    </View>
                  )}
                </TouchableOpacity>

                <Text style={styles.uploadInputLabel}>First Name</Text>
                <TextInput style={styles.uploadInput} placeholder="First Name" value={firstName} onChangeText={setFirstName} />

                <Text style={styles.uploadInputLabel}>Middle Name</Text>
                <TextInput style={styles.uploadInput} placeholder="Middle Name" value={middleName} onChangeText={setMiddleName} />

                <Text style={styles.uploadInputLabel}>Last Name</Text>
                <TextInput style={styles.uploadInput} placeholder="Last Name" value={lastName} onChangeText={setLastName} />

                <Text style={styles.uploadInputLabel}>Username</Text>
                <TextInput style={styles.uploadInput} placeholder="Username" value={userNameField} onChangeText={setUserNameField} />

                <Text style={styles.uploadInputLabel}>Sex</Text>
                <TouchableOpacity style={styles.uploadInput} onPress={() => setShowSexDropdown(!showSexDropdown)}>
                  <Text style={{ color: sex ? "#000" : "#999" }}>{sex || "Select Sex"}</Text>
                  <Ionicons name={showSexDropdown ? "chevron-up" : "chevron-down"} size={20} color="#555" style={{ position: "absolute", right: 12, top: 12 }} />
                </TouchableOpacity>
                {showSexDropdown && (
                  <View style={styles.categoryDropdown}>
                    {["Male", "Female", "PreferNotToSay"].map((item) => (
                      <TouchableOpacity key={item} style={styles.categoryItem} onPress={() => { setSex(item); setShowSexDropdown(false); }}>
                        <Text style={styles.categoryItemText}>{item}</Text>
                      </TouchableOpacity>
                    ))}
                  </View>
                )}

                <Text style={styles.uploadInputLabel}>Birthday</Text>
                <TouchableOpacity style={styles.uploadInput} onPress={() => setShowDatePicker(true)}>
                  <Text style={{ color: birthday ? "#000" : "#999" }}>
                    {birthday ? formattedDate : "Select your birthday"}
                  </Text>
                </TouchableOpacity>
                {showDatePicker && (
                  <DateTimePicker value={birthday} mode="date" display="default" onChange={onChangeDate} />
                )}

                <Text style={styles.uploadInputLabel}>Address</Text>
                <TextInput style={styles.uploadInput} placeholder="Enter your address" value={address} onChangeText={setAddress} />

                <Text style={styles.uploadInputLabel}>Bio</Text>
                <TextInput style={styles.uploadInput} placeholder="Enter your bio" value={bio} onChangeText={setBio} />

                <Text style={styles.uploadInputLabel}>About</Text>
                <TextInput style={[styles.uploadInput, styles.uploadTextArea]} placeholder="Write something about yourself" multiline value={about} onChangeText={setAbout} />

                <TouchableOpacity style={styles.uploadButton} onPress={handleProfileSave}>
                  <Text style={styles.uploadButtonText}>Save Profile</Text>
                </TouchableOpacity>
              </ScrollView>
            </View>
          </View>
        </KeyboardAvoidingView>
      </Modal>

      {/* Art Interests Modal */}
      <Modal visible={interestsModalVisible} animationType="fade" transparent>
        <TouchableWithoutFeedback>
          <View style={styles.modalOverlay}>
            <View style={styles.interestsBox}>
              <Text style={styles.modalTitle}>Choose Your Art Interests</Text>
              <Text style={{ marginBottom: 10, color: '#555', textAlign: 'center' }}>Pick a few to personalize your feed</Text>
              <ScrollView style={{ maxHeight: 400 }} showsVerticalScrollIndicator={false}>
                <View style={styles.interestsGrid}>
                {[
                  { id: 'classical', name: 'Classical Art', color: '#111' },
                  { id: 'contemporary', name: 'Contemporary', color: '#6b21a8' },
                  { id: 'impressionist', name: 'Impressionist', color: '#b45309' },
                  { id: 'abstract', name: 'Abstract', color: '#047857' },
                  { id: 'sculpture', name: 'Sculpture', color: '#1f2937' },
                  { id: 'photography', name: 'Photography', color: '#0ea5e9' },
                  { id: 'digital', name: 'Digital Art', color: '#7c3aed' },
                  { id: 'street', name: 'Street Art', color: '#f59e0b' },
                  { id: 'minimalist', name: 'Minimalist', color: '#4b5563' },
                  { id: 'surrealist', name: 'Surrealist', color: '#ef4444' },
                  { id: 'landscape', name: 'Landscape', color: '#10b981' },
                  { id: 'portrait', name: 'Portrait', color: '#60a5fa' },
                  { id: 'miniature', name: 'Miniature', color: '#f59e0b' },
                  { id: 'expressionist', name: 'Expressionist', color: '#ef4444' },
                  { id: 'realism', name: 'Realism', color: '#10b981' },
                  { id: 'conceptual', name: 'Conceptual', color: '#0ea5e9' },
                ].map((cat) => {
                  const selected = selectedInterests.includes(cat.id);
                  return (
                    <TouchableOpacity
                      key={cat.id}
                      activeOpacity={0.8}
                      onPress={() => {
                        setSelectedInterests((prev) =>
                          prev.includes(cat.id)
                            ? prev.filter((x) => x !== cat.id)
                            : [...prev, cat.id]
                        );
                      }}
                      style={[styles.categoryCard, selected && { borderColor: cat.color, backgroundColor: '#f9fafb' }]}
                    >
                      <View style={[styles.categoryDot, { backgroundColor: cat.color }]} />
                      <Text style={[styles.categoryText, selected && { color: cat.color }]} numberOfLines={1}>
                        {cat.name}
                      </Text>
                    </TouchableOpacity>
                  );
                })}
                </View>
                {!!selectedInterests.length && (
                  <Text style={{ marginTop: 6, marginBottom: 10, color: '#111', fontWeight: '600', textAlign: 'center' }}>
                    {selectedInterests.length} selected
                  </Text>
                )}
              </ScrollView>
              <View style={{ flexDirection: 'row', justifyContent: 'space-between', marginTop: 15, gap: 10 }}>
                <TouchableOpacity
                  style={[styles.cancelButton, { flex: 1, alignItems: 'center', justifyContent: 'center' }]}
                  onPress={() => setInterestsModalVisible(false)}
                >
                  <Text style={styles.cancelButtonText}>Maybe later</Text>
                </TouchableOpacity>
                <TouchableOpacity
                  style={[styles.saveButton, { flex: 1, backgroundColor: '#A68C7B', opacity: selectedInterests.length ? 1 : 0.5, alignItems: 'center', justifyContent: 'center' }]}
                  disabled={!selectedInterests.length}
                  onPress={async () => {
                    const preferences = {
                      classicalArt: selectedInterests.includes('classical'),
                      contemporaryArt: selectedInterests.includes('contemporary'),
                      impressionist: selectedInterests.includes('impressionist'),
                      abstractArt: selectedInterests.includes('abstract'),
                      sculpture: selectedInterests.includes('sculpture'),
                      photography: selectedInterests.includes('photography'),
                      digitalArt: selectedInterests.includes('digital'),
                      streetArt: selectedInterests.includes('street'),
                      minimalist: selectedInterests.includes('minimalist'),
                      surrealist: selectedInterests.includes('surrealist'),
                      landscape: selectedInterests.includes('landscape'),
                      portrait: selectedInterests.includes('portrait'),
                      miniature: selectedInterests.includes('miniature'),
                      expressionist: selectedInterests.includes('expressionist'),
                      realism: selectedInterests.includes('realism'),
                      conceptual: selectedInterests.includes('conceptual'),
                    };
                    try {
                      const res = await fetch(`${API_BASE}/profile/saveArtPreferences`, {
                        method: 'POST',
                        headers: {
                          'Content-Type': 'application/json',
                          'Cookie': `access_token=${accessToken}; refresh_token=${refreshToken}`,
                        },
                        credentials: 'include',
                        body: JSON.stringify(preferences),
                      });
                      if (!res.ok) {
                        let errMsg = `Failed to save preferences (${res.status})`;
                        try {
                          const txt = await res.text();
                          try {
                            const j = txt ? JSON.parse(txt) : null;
                            if (j && (j.message || j.error)) errMsg = `${errMsg}: ${j.message || j.error}`;
                            else if (txt) errMsg = `${errMsg}: ${txt}`;
                          } catch {
                            if (txt) errMsg = `${errMsg}: ${txt}`;
                          }
                        } catch {}
                        throw new Error(errMsg);
                      }
                      setHasArtPreferences(true);
                      setInterestsModalVisible(false);
                    } catch (e) {
                      console.log('saveArtPreferences error:', e?.message || e);
                      alert(e?.message || 'Failed to save preferences');
                    }
                  }}
                >
                  <Text style={styles.saveButtonText}>Continue</Text>
                </TouchableOpacity>
              </View>
            </View>
          </View>
        </TouchableWithoutFeedback>
      </Modal>
    </>
  );
};

export default HomeModal;
